node {
    stage('Removendo Build Anterior'){
        script{
            try{
                sh 'fuser -n tcp -k 8081'
                echo 'Processos na porta 8081 finalizados'
            }catch (Exception e) {
                echo 'Erro ao Finalizar processo: ' + e.toString()
            }
        }
        sh 'rm -r -f /var/lib/jenkins/workspace/DEV-project/APIP*'
        echo "Build Anterior Removida"
    }
    stage('Clonando Projeto') {
        sh 'git clone https://github.com/hemersonallan/APIProducts.git'
        echo 'Projeto Clonado'
    }
    dir('/var/lib/jenkins/workspace/DEV-project/APIProducts/productsapi') {
        stage("Build e Deploy"){
            withEnv(['JENKINS_NODE_COOKIE=dontkill']) {
                sh 'chmod +x mvnw'
                sh 'nohup ./mvnw spring-boot:run -Dserver.port=8081 &'
                sleep(15)
            }     
        }       
    }
    stage('Observability'){
        sh 'curl -l http://3.142.133.157:8081'
    }    
}
