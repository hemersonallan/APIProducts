node {
    stage('Removing Last Build'){
        script{
            try{
                sh 'rm -r -f /var/lib/jenkins/workspace/DEV-project/APIProducts/'
                echo 'Pasta APIProducts removida !!!'
                sh 'fuser -n tcp -k 8081'
                echo 'Processos na porta 8081 finalizados'              
            }catch (Exception e) {
                echo 'Merda ao Finalizar: ' + e.toString()
            }
        }        
        echo 'Build Anterior Removida !!!'  
    }
    stage('Clonando Projeto') {
        sh 'git clone https://github.com/hemersonallan/APIProducts.git'
        echo 'Projeto Clonado'
    }
    dir('/var/lib/jenkins/workspace/DEV-project/APIProducts/productsapi') {
        stage("Build e Deploy"){
            withEnv(['JENKINS_NODE_COOKIE=dontkill']) {
                sh 'chmod +x mvnw'
                sh 'nohup ./mvnw spring-boot:run -Dserver.port=8081 &'
                sleep(15)
                echo 'Deploy Realizado com Sucesso!!!'
            }     
        }       
    }
    stage('Observability'){
        sh 'curl -l https://ebc4-179-251-193-164.ngrok.io'
    }    
}
