node {
    stage('Removing Last Build'){
        script{
            try{
                sh 'rm -r -f /var/lib/jenkins/workspace/DEV-project/APIProducts/'
                echo 'Pasta APIProducts removida !!!'
                sh 'fuser -n tcp -k 8081'
                echo 'Processos na porta 8081 finalizados'              
            }catch (Exception e) {
                echo 'Merda ao Finalizar : ' + e.toString()
            }
        }        
        echo 'Build Anterior Removida !!!'  
    }
    stage('Clonando Projeto') {
        sh 'git clone https://github.com/hemersonallan/APIProducts.git'
        echo 'Projeto Clonado'
    }
    dir('/var/lib/jenkins/workspace/DEV-project/APIProducts/productsapi') {
        stage("Build"){
            sh 'chmod +x mvnw'
            sh './mvnw clean package'
            echo 'Build Realizado com Sucesso!!!'
        } 
        stage("Deploy"){
            withEnv(['JENKINS_NODE_COOKIE=dontkill']) {
                sh 'nohup java -jar /target/productsapi-0.0.1-SNAPSHOT.jar &' 
            }    
        }      
                
              //  sh 'nohup ./mvnw spring-boot:run -Dserver.port=8081 &'
              //  sleep(15)
           //     echo 'Deploy Realizado com Sucesso!!!'
          //  }     
               
    }
    stage('Observability'){
        sh 'curl -i -l http://3.133.140.120:8081'
        echo 'Ok'
    }    
}
